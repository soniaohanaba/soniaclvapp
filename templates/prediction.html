<!DOCTYPE html>
<html>
<head>
	<title>Customer Segmentation of Data</title>
	<link rel="stylesheet" type="text/css" href="/static/css/styles.css">
	<link rel="stylesheet" type="text/css" href="/static/css/grid.css">
	<script type="text/javascript" src="/static/js/chart.js"></script>
</head>
<body>
	<nav style='width:100%; max-width:100%; background:white; height:50px; justify-content:space-between; display:flex'>
	 	<div style="display: flex; align-items: center">
	        <div  style='display:flex; cursor:pointer; margin:11px; flex-direction:column'>
	            <div style='display:flex; flex-direction:row'>
	                <span style='background:black; width:10px;height:10px; margin:2px'> </span>
	                <span style='background:black; width:10px;height:10px; margin:2px'> </span>
	            </div>
	            <div style='display:flex; flex-direction:row'>
	                <span style='background:black; width:10px;height:10px; margin:2px'> </span>
	                <span style='background:black; width:10px;height:10px; margin:2px'> </span>
	            </div>
	        </div>
	        <p class="bold">CLV App</p>
	    </div>
	    <div>
	    	<a class="nav__link" href="/">Home</a>
	        <a class="nav__link" href="/about">About</a>
	        <a class="nav__link" href="/upload">Upload Data</a>
	        <a class="nav__link" href="/describe">Data Description</a>
	        <a class="nav__link" href="/rfm">Customer Segmentation</a>
	        <a class="nav__link" href="/predict">Prediction</a>
	    </div>
    </nav>
	<h1>Prediction</h1>
	<div class="container">
		<div class="row" style="align-items: center;">
			<div class="col-12">
				<b class="loading_indicator"></b>
			</div>
		</div>
		<div class="row" style="align-items: center;">
			<div class="col-12">
				<label>
					Select country for description
					<select class="input" id="countries">
						<option value="country">Country</option>
						
					</select>
				</label>
			</div>
		</div>
		<div class="row" style="align-items: center;">
			<div class="col-6">
				<label>
					Select start month for RFM
					<input class="input" type="date" name="rfm_start" id="rfm_start">
				</label>
			</div>
			<div class="col-6">
				<label>
					Select end month for RFM
					<input class="input" type="date" name="rfm_end" id="rfm_end">
				</label>
			</div>
		</div>
		<div class="row" style="align-items: center;">
			<div class="col-6">
				<label>
					Select date for LTV Prediction
					<input class="input" type="date" name="prediction_date" id="prediction_date">
				</label>
			</div>
			<div class="col-6">
				<label>
					Input percentage of training data set for prediction
					<input class="input" type="text" name="training_percent" id="training_percent">
				</label>
			</div>
			<div class="col-12" style="text-align: center; justify-content: center;">
				<button id="predict" class="button">Predict</button>
			</div>
		</div>
		
	</div>

	<script type="text/javascript">
		var DATA = ({{data | safe}});
		var GRAPH_DATA = []
		var COUNTRIES = []
		var COUNTRY_DATA = [];
		var SELECTED_COUNTRY = [];

	</script>

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
	<script type="text/javascript">

		var predict_button = document.getElementById("predict");
		predict_button.addEventListener("click", async function(event){
			await predict();
		})

		function is_date(date_string){
			return (new Date(date_string)) != 'Invalid Date';
		}

		async function predict(){
			var selected_country = document.getElementById("countries").value;
			var rfm_start_date = document.getElementById("rfm_start").value;
			var rfm_end_date = document.getElementById("rfm_end").value;
			var prediction_date = document.getElementById("prediction_date").value;
			var training_percent = document.getElementById("training_percent").value;

			// check if training percentage is number
			training_percent = Number(training_percent)
			if(!training_percent){
				alert("Please input a number for training data set");
				return;
			}
			// check if the percentage is between 0-100
			if(training_percent > 100 || training_percent < 0){
				alert("Training data percentage should be between 0 and 100");
				return;
			}

			if (!is_date(rfm_start_date)){
				alert("Please select a valid start date for RFM analysis");
				return;
			}

			if(!is_date(rfm_end_date)){
				alert("Please select a valid end date for RFM analysis");
				return;
			}

			if(!is_date(prediction_date)){
				alert("Please select a valid date for prediction");
				return;
			}

			if((new Date(rfm_end_date)) >= (new Date(prediction_date))){
				alert("Prediction date must be older than RFM end date");
				return;
			}

			var request_params = {
				"country": selected_country,
				"rfm_start_date": rfm_start_date,
				"rfm_end_date": rfm_end_date,
				"prediction_date": prediction_date,
				"training_percent": training_percent,
			}

			var response = await http_request('get', '/predict', request_params, null, " predicting customer LTV", "Predicting customers LTV")

			console.log(response)
		}

		function display_status_message(message){
			var loading_indicators = document.getElementsByClassName('loading__indicator');
			for(var i = 0; i < loading_indicators.length; i++){
				loading_indicators[i].classList.remove('hide');
				loading_indicators[i].innerHTML = message ? message : 'Loading...';
			}
			window.scroll(0,0);
		}

		function hide_status_message(){
			var loading_indicators = document.getElementsByClassName('loading__indicator');
			for(var i = 0; i < loading_indicators.length; i++){
				loading_indicators[i].classList.add('hide');
			}
		}

		function clearNode(node){
			while(node.firstChild){
				node.removeChild(node.firstChild);
			}
			return node;
		}

		function add_select_options(data, select_tag, value_key, inner_html_key){
			var select_element = document.getElementById(select_tag);
			select_element = clearNode(select_element);
			for (var i = 0; i < data.length; i++){
				var option = document.createElement("option");
				option.value = data[i][value_key];
				option.innerHTML = data[i][inner_html_key];
				select_element.appendChild(option);
			}
		}

		async function http_request(method, path, params, data, reason, loading_message){
			display_status_message(loading_message)
			try{
				var request_body = {
					method: method, 
					url: path,
					headers: {
					'content-type':'application/x-www-form-urlencoded; charset=utf-8'}
				}
				request_body['params'] = params ? params : {}
				request_body['data'] = data ? data : {}
				console.log("data sent across is ", data);
				var response = await axios(request_body);
				if(response.status >= 200 && response.status <= 300){
					hide_status_message();
					return response.data;
				}
				var error_message = "There was an error in "+ (reason ? reason : "request ");
				alert(error_message)
				hide_status_message();
				return;
			} catch (exc){
				var response = exc.response.data 
				var error_message = (response && response['message']) ? response['message'] : ("There was an error fetching data for "+ (reason ? reason : " request"));
				hide_status_message();
				return {exception:exc, error:true, message:error_message}
			}
		}
		
	</script>

</body>
</html>